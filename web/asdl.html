<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">

<html>

	<head>
		<meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
		<link title="David R. Hanson" href="http://drh.home.dyndns.org" rev="made">
		<link href="style.css" rel="stylesheet" type="text/css" media="all">
		<title>Using ASDL with lcc 4.1</title>
		<base href="http://www.cs.princeton.edu/software/lcc/">
	</head>

	<body>
		<p><span class="banner"><a href="http://www.cs.princeton.edu">Princeton CS</a> &raquo; <a href="http://www.cs.princeton.edu/software">Software</a> &raquo; <a href="http://www.cs.princeton.edu/software/lcc/">lcc, A Retargetable C Compiler</a> &raquo; Using ASDL with lcc 4.1</span></p>
		<h1>Using ASDL with lcc 4.1</h1>
		<p>The lcc 4.1 distribution includes the files necessary to emit <a href="http://asdl.sourceforge.net">ASDL</a>, as described in:</p>
		<blockquote>
			<p>D. R. Hanson, Early Experience with ASDL in lcc, <cite>Software&#151;Practice and Experience </cite><b>29</b> (5), 417-435, 4/25/99. <a href="http://storage.webhop.net/documents/asdl.pdf"><font size="-1">PDF</font></a> (120 KB).<br>
				Slides of the talk at the National Compiler Infrastructure Tutorial, <cite>PLDI'98</cite>, 6/19/98. <a href="http://storage.webhop.net/documents/nci@pldi98.pdf"><font size="-1">PDF</font></a> (71KB).</p>
		</blockquote>
		<p>Rebuilding lcc 4.1 to include ASDL support on UNIX platforms involves the following steps.</p>
		<ol>
			<li>Install and test lcc 4.1; see <cite><a href="http://drh.svnrepository.com/svn/lcc/tags/v4_1/doc/install.html">Installing lcc</a></cite>.
			<li>Install <a href="http://sourceforge.net/project/showfiles.php?group_id=30672">ASDL version 1.2</a>. Make sure you set the environement variable <code>ASDL_HOME</code> to the root of your ASDL installation directory.
			<li>Add the line shown on bold type below to <code>src/inits.c</code>:
				<blockquote>
					<pre>void init(int argc, char *argv[]) {
	{extern void input_init(int, char *[]); input_init(argc, argv);}
	{extern void main_init(int, char *[]); main_init(argc, argv);}
	{extern void prof_init(int, char *[]); prof_init(argc, argv);}
	{extern void trace_init(int, char *[]); trace_init(argc, argv);}
	{extern void type_init(int, char *[]); type_init(argc, argv);}
	{extern void x86linux_init(int, char *[]); x86linux_init(argc, argv);}
<strong>	{extern void asdl_init(int, char *[]); asdl_init(argc, argv);}</strong>
}</pre>
				</blockquote>
			<li>Add the following lines to your <code>custom.mk</code>, creating one if necessary.
				<blockquote>
					<pre>EXTRALIBS=-L$(ASDL_HOME)/lib/asdlGen -lasdl -lcii
EXTRAOBJS=$(BUILDDIR)/asdl$O $(BUILDDIR)/rcc$O

all::	$(BUILDDIR)/pass2$E $(BUILDDIR)/2html$E</pre>
				</blockquote>
				<p>These lines augment the rules in the <code><a href="http://drh.svnrepository.com/svn/lcc/tags/v4_1/makefile">makefile</a></code> so that it generates <code>$(BUILDDIR)/rcc.h</code> and <code>$(BUILDDIR)/rcc.c</code> from the ASDL grammar for lcc pickles in <code><a href="http://drh.svnrepository.com/svn/lcc/tags/v4_1/src/rcc.asdl">src/rcc.asdl</a></code>, compiles these generated files, and compiles <code><a href="http://drh.svnrepository.com/svn/lcc/tags/v4_1/src/asdl.c">src/asdl.c</a></code> (the ASDL &quot;back end&quot;), <code><a href="http://drh.svnrepository.com/svn/lcc/tags/v4_1/src/pass2.c">src/pass2.c</a></code> (reads pickles, emits assembly language), and <code><a href="http://drh.svnrepository.com/svn/lcc/tags/v4_1/src/2html.c">src/2html.c</a></code> (reads pickles, emits HTML).</p>
			<li>Rebuild lcc, i.e., execute
				<blockquote>
					<pre>% make CUSTOM=custom.mk all</pre>
				</blockquote>
				<p>This step builds a new <code>rcc</code> (the compiler proper), <code>pass2</code>, and <code>2html</code>.</p>
			<li>Copy <code>pass2</code> to <code>/usr/local/bin</code>, or a plant a symbolic link to it as suggested in <a href="http://drh.svnrepository.com/svn/lcc/tags/v4_1/doc/install.html#unix"><cite>Installation on UNIX</cite></a>. You can also copy to link to <code>2html</code>, which reads ASDL pickles and emits HTML.
		</ol>
		<p>Once you've installed the compiler, you can generate ASDL pickles by giving the <code>-Wf-asdl</code> and <code>-S</code> options, e.g.,</p>
		<blockquote>
			<pre>% lcc -Wf-asdl -S -o wf1.pickle tst/wf1.c</pre>
		</blockquote>
		<p>As shown, use the <code>-o</code> option to specify the file name for the pickle; if you omit this option, the pickle lands in, for example, <code>wf1.s</code>.</p>
		<p>pass2 reads a pickle and emits assembly language, as usual, e.g.,</p>
		<blockquote>
			<pre>% pass2 wf1.pickle wf1.s
% lcc wf1.s</pre>
		</blockquote>
		<p>These commands generate assembly code from <code>wf1.pickle</code>, and assemble and link it into <code>a.out</code>. The assembly code generated&nbsp; by <code>pass2</code> is often identical to that generated by lcc directly. When there are differences, they are usually due to differences in compiler-generated label numbers.</p>
		<p>Rebuilding lcc 4.1 on Windows NT/95/98 to support ASDL involves the analogous steps. The Windows makefile, <code><a href="http://drh.svnrepository.com/svn/lcc/tags/v4_1/makefile.nt">makefile.nt</a></code>, doesn't support includes, so you'll have to edit the file to add the <code>EXTRALIBS</code> and <code>EXTRAOBJS</code> definitions and the additional prerequisites for the <code>all</code> target.</p>
		<hr>
		<address><a href="http://drh.home.dyndns.org">David Hanson</a><br>
			$Revision$ $Date$</address>
	</body>

</html>